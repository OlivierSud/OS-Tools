<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>G√©n√©rateur de GIF / APNG</title>
  <style>
    :root{ --bg:#061c30; --panel:#082137; --panel-2:#051727; --border:#051727; --text:#d7dde7; --muted:#9aa5b1; --accent1:#4f8cff; --accent2:#7a5cff; --accent3:#4fff95; --accent4:#5cff85; }
    html,body{ height:100%; margin:0; }
    body{ display:flex; flex-direction:column; min-height:100vh; background:var(--bg); color:var(--text); font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding:0; }
    #topbar{ display:flex; gap:10px; align-items:center; padding:12px; background:linear-gradient(90deg,#242c3b,#1c1f25); border-bottom:1px solid var(--border); }
    .btn{ border:0; padding:10px 16px; border-radius:10px; color:#fff; font-weight:700; cursor:pointer; background:linear-gradient(135deg,var(--accent1),var(--accent2)); box-shadow:0 6px 16px rgba(79,140,255,.18); transition:transform .12s ease, filter .15s ease; display:inline-block; }
    .btn:hover{ transform:translateY(-2px); background:linear-gradient(135deg,var(--accent3),var(--accent4)); color:#011b0a; }
    .btn:active{ transform:translateY(2px); }
    .wrap{ flex:1; display:flex; flex-direction:column; padding:12px; gap:12px; }
    .card{ background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; }
    h2{ margin:0 0 8px 0; font-size:18px; }
    label{ display:block; margin:6px 0; }
    input[type="file"], input[type="number"], select{ padding:8px; border-radius:10px; border:1px solid rgba(255,255,255,0.2); background:#0f162b; color:var(--text); }
    input:disabled, select:disabled{ opacity:.6; }
    img.preview{ max-height:100px; margin:5px; border-radius:8px; box-shadow:0 0 6px rgba(0,0,0,0.5); }
    #gif-container img{ max-width:600px; width:100%; height:auto; margin-top:10px; border-radius:10px; box-shadow:0 0 12px rgba(0,0,0,0.6); }
    #loading{ font-style:italic; color:var(--muted); margin-top:10px; text-align:center; display:none; }
    #loading span { display:inline-block; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100% { opacity:1; transform:scale(1);} 50% { opacity:0.5; transform:scale(1.05);} }
    .progress-bar { width:100%; height:8px; background:#1c1f2c; border-radius:6px; overflow:hidden; margin-top:6px; display:none; }
    .progress-fill { height:100%; width:0%; background:linear-gradient(270deg,var(--accent1),var(--accent2),var(--accent3),var(--accent4)); background-size:400% 100%; transition: width 0.2s; }
    .progress-fill.animate { animation: slideGradient 4s linear infinite; }
    @keyframes slideGradient { 0% { background-position:400% 0%; } 100% { background-position:0% 0%; } }
    .options{ margin:10px 0; padding:12px; border-radius:10px; background:#0e1426; border:1px solid rgba(255,255,255,.08); }
    .size-group{ margin-top:8px; }
    .size-disabled{ opacity:.5; pointer-events:none; }
    #preview{ display:flex; flex-wrap:wrap; margin-top:10px; }
    input[type="color"] { padding:0; border:none; background:none; width:40px; height:30px; cursor:pointer; }
    .color-alpha-group { display:flex; align-items:center; gap:12px; margin-top:8px; }
    .color-disabled { opacity:0.5; pointer-events:none; }
    .actions { display:flex; align-items:center; gap:12px; margin-top:10px; flex-wrap:wrap; }
    #file-size { color:var(--muted); font-size:13px; }
    #file-name { padding:8px; border-radius:6px; border:1px solid #444; background:#0f162b; color:var(--text); display:none; }
  </style>
</head>
<body>
  <div id="topbar">
    <input type="file" id="images" accept="image/*" multiple hidden>
    <label for="images" class="btn">‚¨áÔ∏è Importer images</label>
  </div>

  <div class="wrap">
    <div class="card">
      <h2>üéûÔ∏è G√©n√©rateur de GIF / APNG anim√©</h2>
      Dur√©e par image (ms): <input type="number" id="duration" value="200" min="10">
      <div class="options">
        <label><input type="checkbox" id="loop" checked> Lire en boucle</label>
        <label><input type="checkbox" id="reverse"> Inverser l‚Äôordre des images</label>
        <label><input type="checkbox" id="use-original-size" checked onchange="toggleSizeInputs()"> Utiliser la taille originale</label>
        <div class="size-group" id="size-group">
          Largeur: <input type="number" id="width" value="500" disabled>
          Hauteur: <input type="number" id="height" value="500" disabled>
          Unit√©:
          <select id="size-unit" disabled>
            <option value="px">px</option>
            <option value="%">%</option>
          </select>
        </div>
        <div class="color-alpha-group">
          <label id="bg-color-label">üé® Couleur de fond (si alpha):
            <input type="color" id="bg-color" value="#000000">
          </label>
          <label><input type="checkbox" id="keep-alpha"> Garder alpha (export APNG)</label>
        </div>
      </div>

      <div class="actions">
        <button class="btn" onclick="generateAnimation()">‚ö° G√©n√©rer</button>
        <a id="download-btn" class="btn" href="#" style="display:none;">üíæ Exporter</a>
        <input type="text" id="file-name" placeholder="Nom du fichier">
        <span id="file-size"></span>
      </div>

      <div id="loading">‚è≥ G√©n√©ration en cours<span></span></div>
      <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>

      <div id="preview"></div>
      <div id="gif-container"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.js"></script>

  <script>
    fetch("https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.worker.js")
      .then(r => r.text())
      .then(code => {
        const workerBlob = new Blob([code], { type: "application/javascript" });
        const workerURL = URL.createObjectURL(workerBlob);
        window.startApp(workerURL);
      });

    function toggleSizeInputs() {
      const checked = document.getElementById('use-original-size').checked;
      const group = document.getElementById('size-group');
      const inputs = group.querySelectorAll('input, select');
      inputs.forEach(input => input.disabled = checked);
      group.classList.toggle('size-disabled', checked);
    }

    function startApp(workerURL) {
      const imagesInput = document.getElementById('images');
      const previewDiv = document.getElementById('preview');
      const container = document.getElementById('gif-container');
      const loading = document.getElementById('loading');
      const progressBar = document.querySelector('.progress-bar');
      const progressFill = document.getElementById('progress-fill');
      const downloadBtn = document.getElementById('download-btn');
      const fileSizeSpan = document.getElementById('file-size');
      const fileNameInput = document.getElementById('file-name');

      const loopCb = document.getElementById('loop');
      const reverseCb = document.getElementById('reverse');
      const sizeCb = document.getElementById('use-original-size');
      const widthInput = document.getElementById('width');
      const heightInput = document.getElementById('height');
      const unitInput = document.getElementById('size-unit');
      const bgColorInput = document.getElementById('bg-color');
      const bgColorLabel = document.getElementById('bg-color-label');
      const keepAlphaCb = document.getElementById('keep-alpha');

      let files = [];

      imagesInput.addEventListener('change', e => {
        files = Array.from(e.target.files);
        previewDiv.innerHTML = '';
        container.innerHTML = '';
        downloadBtn.style.display = 'none';
        fileSizeSpan.textContent = '';
        fileNameInput.style.display = 'none';
        if(files.length>0){
          const firstName = files[0].name.split('.').slice(0,-1).join('.');
          fileNameInput.value = firstName; // valeur par d√©faut
          fileNameInput.placeholder = firstName;
        }
        files.forEach(file => {
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          img.className = "preview";
          previewDiv.appendChild(img);
        });
      });

      keepAlphaCb.addEventListener('change', () => {
        if (keepAlphaCb.checked) {
          bgColorLabel.classList.add("color-disabled");
          bgColorInput.disabled = true;
        } else {
          bgColorLabel.classList.remove("color-disabled");
          bgColorInput.disabled = false;
        }
      });

      window.generateAnimation = function () {
        const durationValue = parseInt(document.getElementById('duration').value) || 200;
        const shouldLoop = loopCb.checked;
        const shouldReverse = reverseCb.checked;
        const useOriginalSize = sizeCb.checked;
        const keepAlpha = keepAlphaCb.checked;
        const bgColor = bgColorInput.value;

        container.innerHTML = '';
        downloadBtn.style.display = 'none';
        fileNameInput.style.display = 'inline-block';
        fileSizeSpan.textContent = '';
        loading.style.display = 'block';
        progressBar.style.display = 'block';
        progressFill.style.width = "0%";

        // Relancer l'animation de gradient
        progressFill.classList.remove('animate');
        void progressFill.offsetWidth;
        progressFill.classList.add('animate');

        const loadImgs = files.map(file => new Promise((res, rej) => {
          const img = new Image();
          img.onload = () => res(img);
          img.onerror = () => rej("Erreur : " + file.name);
          img.src = URL.createObjectURL(file);
        }));

        Promise.all(loadImgs).then(images => {
          if (shouldReverse) images.reverse();
          let width = images[0].width;
          let height = images[0].height;
          if (!useOriginalSize) {
            const w = parseFloat(widthInput.value);
            const h = parseFloat(heightInput.value);
            if(unitInput.value === '%') { width = Math.round(images[0].width*(w/100)); height = Math.round(images[0].height*(h/100)); }
            else { width = w; height = h; }
          }

          // === Nom du fichier pris en compte correctement d√®s la premi√®re g√©n√©ration ===
          const currentFileName = fileNameInput.value.trim() || (files[0]? files[0].name.split('.').slice(0,-1).join('.') : "animation");

          if(keepAlpha) {
            const frames = [];
            const delays = [];
            const canvas = document.createElement('canvas'); canvas.width=width; canvas.height=height;
            const ctx = canvas.getContext('2d');
            images.forEach((img,i)=>{
              ctx.clearRect(0,0,width,height);
              ctx.drawImage(img,0,0,width,height);
              frames.push(ctx.getImageData(0,0,width,height).data.buffer);
              delays.push(durationValue);
              progressFill.style.width = ((i+1)/images.length*70) + "%";
            });
            const apng = UPNG.encode(frames,width,height,0,delays);
            const blob = new Blob([apng],{type:"image/apng"});
            const url = URL.createObjectURL(blob);
            const out = document.createElement('img'); out.src=url; container.appendChild(out);
            progressFill.style.width="100%"; progressFill.classList.remove('animate');
            downloadBtn.href=url; downloadBtn.download=currentFileName+".apng"; downloadBtn.textContent="üíæ Exporter en APNG"; downloadBtn.style.display="inline-block";
            fileSizeSpan.textContent="("+ (blob.size/(1024*1024)).toFixed(2)+" Mo)";
            loading.style.display="none";
          } else {
            const gif = new GIF({workers:2,quality:10,workerScript:workerURL,repeat:shouldLoop?0:-1});
            gif.setOptions({width,height});
            const canvas = document.createElement('canvas'); canvas.width=width; canvas.height=height;
            const ctx = canvas.getContext('2d');
            images.forEach((img,i)=>{
              ctx.clearRect(0,0,width,height);
              ctx.fillStyle = bgColor; ctx.fillRect(0,0,width,height);
              ctx.drawImage(img,0,0,width,height);
              gif.addFrame(ctx,{delay:durationValue,copy:true});
              progressFill.style.width=((i+1)/images.length*70)+"%";
            });
            gif.on('finished', blob=>{
              const result=document.createElement('img'); result.src=URL.createObjectURL(blob);
              container.innerHTML=''; container.appendChild(result);
              progressFill.style.width="100%"; progressFill.classList.remove('animate');
              downloadBtn.href=result.src; downloadBtn.download=currentFileName+".gif"; downloadBtn.textContent="üíæ Exporter en GIF"; downloadBtn.style.display="inline-block";
              fileSizeSpan.textContent="("+ (blob.size/(1024*1024)).toFixed(2)+" Mo)";
              loading.style.display="none";
            });
            gif.render();
          }

        }).catch(err=>{
          alert(err); loading.style.display='none'; progressBar.style.display='none'; progressFill.classList.remove('animate');
        });
      };
    }
  </script>
</body>
</html>
