<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Générateur de Normal Map v3.1</title>

  <!-- BabylonJS -->
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

  <!-- Ton CSS principal -->
  <link rel="stylesheet" href="./3d-normal-map-generator/3D-normal-map-generator.css">
</head>
<body>

<div class="container">
  <!-- === PANNEAU CONTRÔLES === -->
  <div class="panel controls-panel">
    <h1>Paramètres</h1>
    
    <!-- SECTION 1 : Import -->
    <div class="accordion-section">
      <h2 class="accordion-header"><span class="arrow">▾</span> 1. Importer un fichier source</h2>
      <div class="accordion-content">
        <div class="file-input-row">
          <input type="file" id="imageLoader" accept="image/*" hidden>
          <label for="imageLoader" class="custom-file-btn">📁 Choisir un fichier</label>
          <span id="fileName" class="file-name">Aucun fichier sélectionné</span>
        </div>
      </div>
    </div>

    <!-- SECTION 2 : Heightmap -->
    <div class="accordion-section">
      <h2 class="accordion-header"><span class="arrow">▾</span> 2. Génération de la Heightmap</h2>
      <div class="accordion-content">
        <input type="checkbox" id="enableHeightmap" checked>
        <label for="enableHeightmap" class="checkbox-label">Activer la génération de Heightmap</label>
        <div id="heightmap-options" style="margin-top:10px;">
          <label for="hmLargeShapes">Formes Larges <span id="hmLargeShapesValue" class="value-display">0.60</span></label>
          <input type="range" id="hmLargeShapes" min="0" max="1" value="0.6" step="0.01">
          <label for="hmMediumDetails">Détails Moyens <span id="hmMediumDetailsValue" class="value-display">0.60</span></label>
          <input type="range" id="hmMediumDetails" min="0" max="3" value="0.6" step="0.01">
          <label for="hmFineDetails">Détails Fins <span id="hmFineDetailsValue" class="value-display">0.60</span></label>
          <input type="range" id="hmFineDetails" min="0" max="3" value="0.6" step="0.01">
          <label for="hmIntensity">Intensité Globale <span id="hmIntensityValue" class="value-display">2.00</span></label>
          <input type="range" id="hmIntensity" min="0" max="3" value="2.0" step="0.01">
          <label for="hmSmoothing">Lissage Final <span id="hmSmoothingValue" class="value-display">2.0</span></label>
          <input type="range" id="hmSmoothing" min="0" max="5" value="2.0" step="0.1">
        </div>
      </div>
    </div>

    <!-- SECTION 3 : Normal Map -->
    <div class="accordion-section">
      <h2 class="accordion-header"><span class="arrow">▾</span> 3. Réglages de la Normal Map</h2>
      <div class="accordion-content">
        <label for="intensity">Intensité <span id="intensityValue" class="value-display">1.00</span></label>
        <input type="range" id="intensity" min="0" max="100" value="63" step="1">
        <label for="smallDetails">Petits Détails (Lissage) <span id="smallDetailsValue" class="value-display">0.10</span></label>
        <input type="range" id="smallDetails" min="0" max="1" value="0.1" step="0.01">
        <label for="mediumDetails">Moyens Détails <span id="mediumDetailsValue" class="value-display">0.10</span></label>
        <input type="range" id="mediumDetails" min="0" max="1" value="0.1" step="0.01">
        <label for="largeDetails">Grands Détails <span id="largeDetailsValue" class="value-display">0.10</span></label>
        <input type="range" id="largeDetails" min="0" max="1" value="0.1" step="0.01">
      </div>
    </div>

    <!-- SECTION 4 : Roughness -->
    <div class="accordion-section">
      <h2 class="accordion-header"><span class="arrow">▾</span> 4. Roughness Map (nouveau)</h2>
      <div class="accordion-content">
        <label for="levelsBlack">Niveau noir <span id="levelsBlackValue" class="value-display">0</span></label>
        <input type="range" id="levelsBlack" min="0" max="255" value="0" step="1">

        <label for="levelsGamma">Gamma <span id="levelsGammaValue" class="value-display">1.00</span></label>
        <input type="range" id="levelsGamma" min="0.1" max="3" value="1" step="0.01">

        <label for="levelsWhite">Niveau blanc <span id="levelsWhiteValue" class="value-display">255</span></label>
        <input type="range" id="levelsWhite" min="0" max="255" value="255" step="1">

        <div style="margin-top:10px;">
          <input type="checkbox" id="invertRough">
          <label for="invertRough" class="checkbox-label">Inverser les noirs et blancs</label>
        </div>
      </div>
    </div>
  </div>

  <!-- === PANEL APERÇU === -->
  <div class="panel preview-panel">
    <div class="preview-header">
      <h2>Aperçu</h2>
      <button id="exportTexturesBtn" class="export-btn">💾 Exporter</button>
    </div>

    <div class="view-switcher">
      <button id="viewNormalBtn" class="active">Normal Map</button>
      <button id="viewHeightmapBtn">Heightmap</button>
      <button id="viewSourceBtn">Source</button>
      <button id="viewRoughBtn">Roughness</button>
    </div>

    <div class="main-preview-container">
      <canvas id="normalMapCanvas" width="1024" height="1024"></canvas>
      <img id="mainPreviewImage" src="" alt="Aperçu principal" style="display:none;">
    </div>

    <!-- Visionneuse 3D -->
    <div class="control-group" style="margin-top:20px;width:100%;max-width:512px;">
      <h2 style="font-size:1.1em;margin-bottom:5px;">Aperçu 3D</h2>
      <canvas id="threeCanvas"></canvas>
      <div class="mesh-switcher" style="margin-top:10px; display:flex; gap:10px; justify-content:center;">
    <button id="btnCube">Cube</button>
    <button id="btnSphere">Sphere</button>
    <button id="btnSwitchEnv">Switch Env</button>
  </div>


  <!-- Nouveau slider Roughness globale -->
  <div class="slider-label-container" style="margin-top:10px;">
    <label for="roughnessSlider">Roughness globale <span id="roughnessValue" class="value-display">0.5</span></label>
    <input type="range" id="roughnessSlider" min="0" max="1" value="0.5" step="0.01">
  </div>
</div>

    
  </div>
</div>

<!-- === POPUP EXPORT === -->
<div id="exportPopup" class="export-popup">
  <div class="popup-content">
    <h3>💾 Exporter les textures</h3>
    <div class="file-list">
      <div class="file-item">
        <label>Base</label>
        <div class="file-row">
          <input id="nameBase" placeholder="nom_base.png">
          <button class="save-icon" data-type="base" title="Exporter la texture source">💾</button>
        </div>
      </div>
      <div class="file-item">
        <label>Roughness</label>
        <div class="file-row">
          <input id="nameRough" placeholder="nom_rough.png">
          <button class="save-icon" data-type="rough" title="Exporter la roughness map">💾</button>
        </div>
      </div>
      <div class="file-item">
        <label>Heightmap</label>
        <div class="file-row">
          <input id="nameHigh" placeholder="nom_height.png">
          <button class="save-icon" data-type="high" title="Exporter la heightmap">💾</button>
        </div>
      </div>
      <div class="file-item">
        <label>Normal Map</label>
        <div class="file-row">
          <input id="nameNM" placeholder="nom_normal.png">
          <button class="save-icon" data-type="nm" title="Exporter la normal map">💾</button>
        </div>
      </div>
    </div>

    <div class="popup-buttons">
      <button id="cancelExport" class="popup-cancel">Fermer</button>
    </div>
  </div>
</div>


<!-- === Scripts === -->
<script src="./3d-normal-map-generator/3D-normal-map-generator.heightmap.js"></script>
<script src="./3d-normal-map-generator/3D-normal-map-generator.normalmap.js"></script>
<script src="./3d-normal-map-generator/3D-normal-map-generator.roughness.js"></script>
<script src="./3d-normal-map-generator/3D-normal-map-generator.main.js"></script>

<script>
// Gestion de l’affichage des valeurs sliders
const sliders = [
  { id: "hmLargeShapes", default: 0.6 },
  { id: "hmMediumDetails", default: 0.6 },
  { id: "hmFineDetails", default: 0.6 },
  { id: "hmIntensity", default: 2.0 },
  { id: "hmSmoothing", default: 2.0 },
  { id: "intensity", default: 63 },
  { id: "smallDetails", default: 0.1 },
  { id: "mediumDetails", default: 0.1 },
  { id: "largeDetails", default: 0.1 },
  { id: "levelsBlack", default: 0 },
  { id: "levelsGamma", default: 1.0 },
  { id: "levelsWhite", default: 255 }
];

function enhanceSlider(cfg) {
  const slider = document.getElementById(cfg.id);
  if (!slider) return;
  const label = slider.previousElementSibling;
  const valueSpan = label.querySelector(".value-display");
  slider.addEventListener("input", () => valueSpan.textContent = slider.value);
}
sliders.forEach(enhanceSlider);

// Génération automatique de la roughness
["levelsBlack", "levelsGamma", "levelsWhite", "invertRough"].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener("input", () => {
    if (window.generateRoughnessMap) window.generateRoughnessMap();
  });
});
</script>


</body>
</html>
