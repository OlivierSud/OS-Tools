<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G√©n√©rateur de Normal Map v3.1</title>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

  <!-- remplace le <style> inline par un fichier CSS externe -->
  <link rel="stylesheet" href="./3d-normal-map-generator/3D-normal-map-generator.css">
</head>
<body>

<div class="container">
    <div class="panel controls-panel">
        <h1>Param√®tres</h1>

        <div class="control-group">
            <h2>1. Importer un fichier source</h2>
            <div class="file-input-row">
                <input type="file" id="imageLoader" name="imageLoader" accept="image/*" hidden>
                <label for="imageLoader" class="custom-file-btn">üìÅ Choisir un fichier</label>
                <span id="fileName" class="file-name">Aucun fichier s√©lectionn√©</span>
            </div>
        </div>

        <div class="control-group" id="heightmapControls">
            <h2>2. G√©n√©ration de la Heightmap</h2>
            <input type="checkbox" id="enableHeightmap" checked>
            <label for="enableHeightmap" class="checkbox-label">Activer la g√©n√©ration de Heightmap</label>
            
            <div id="heightmap-options" style="margin-top: 10px;">
                <label for="hmLargeShapes">Formes Larges <span id="hmLargeShapesValue" class="value-display">0.60</span></label>
                <input type="range" id="hmLargeShapes" min="0" max="1" value="0.6" step="0.05">

                <label for="hmMediumDetails">D√©tails Moyens <span id="hmMediumDetailsValue" class="value-display">0.60</span></label>
                <input type="range" id="hmMediumDetails" min="0" max="3" value="0.6" step="0.05">

                <label for="hmFineDetails">D√©tails Fins <span id="hmFineDetailsValue" class="value-display">0.60</span></label>
                <input type="range" id="hmFineDetails" min="0" max="3" value="0.6" step="0.05">
                
                <label for="hmIntensity">Intensit√© Globale <span id="hmIntensityValue" class="value-display">2.00</span></label>
                <input type="range" id="hmIntensity" min="0" max="3" value="2.0" step="0.05">

                <label for="hmSmoothing">Lissage Final <span id="hmSmoothingValue" class="value-display">2.0</span></label>
                <input type="range" id="hmSmoothing" min="0" max="5" value="2.0" step="0.1">
            </div>
        </div>

        <div class="control-group">
            <h2>3. R√©glages de la Normal Map</h2>
            <label for="intensity">Intensit√© <span id="intensityValue" class="value-display">1.00</span></label>
            <input type="range" id="intensity" min="0" max="100" value="63" step="1">

            <label for="smallDetails">Petits D√©tails (Lissage) <span id="smallDetailsValue" class="value-display">0.10</span></label>
            <input type="range" id="smallDetails" min="0" max="1" value="0.1" step="0.01">

            <label for="mediumDetails">Moyens D√©tails <span id="mediumDetailsValue" class="value-display">0.10</span></label>
            <input type="range" id="mediumDetails" min="0" max="1" value="0.1" step="0.01">

            <label for="largeDetails">Grands D√©tails <span id="largeDetailsValue" class="value-display">0.10</span></label>
            <input type="range" id="largeDetails" min="0" max="1" value="0.1" step="0.01">
        </div>
        
        <div class="control-group">
            <h2>4. Roughness Map (nouveau)</h2>
            <label for="roughDarkIntensity">Intensit√© tons sombres <span id="roughDarkValue" class="value-display">1.00</span></label>
            <input type="range" id="roughDarkIntensity" min="0" max="2" value="1" step="0.01">

            <label for="roughLightIntensity">Intensit√© tons clairs <span id="roughLightValue" class="value-display">1.00</span></label>
            <input type="range" id="roughLightIntensity" min="0" max="2" value="1" step="0.01">

            <div style="margin-top:8px;">
              <label>Levels (Photoshop-like)</label>
              <label for="levelsBlack">Noir <span id="levelsBlackValue" class="value-display">0</span></label>
              <input type="range" id="levelsBlack" min="0" max="255" value="0" step="1">
              <label for="levelsGamma">Gamma <span id="levelsGammaValue" class="value-display">1.00</span></label>
              <input type="range" id="levelsGamma" min="0.1" max="5" value="1" step="0.01">
              <label for="levelsWhite">Blanc <span id="levelsWhiteValue" class="value-display">255</span></label>
              <input type="range" id="levelsWhite" min="0" max="255" value="255" step="1">
            </div>

            <label style="margin-top:8px;"><input type="checkbox" id="invertRough"> Inverser noir/blanc</label>
        </div>
    </div>

    <div class="panel preview-panel">
        <h2>Aper√ßu</h2>
        <div class="view-switcher">
            <button id="viewNormalBtn" class="active">Normal Map</button>
            <button id="viewHeightmapBtn">Heightmap</button>
            <button id="viewSourceBtn">Source</button>
            <button id="viewRoughBtn">Roughness</button>
        </div>
        <div class="main-preview-container">
            <canvas id="normalMapCanvas" width="512" height="512"></canvas>
            <img id="mainPreviewImage" src="" alt="Aper√ßu principal" />
        </div>

        <div class="control-group" style="margin-top: 20px; width: 100%; max-width: 512px;">
            <h2 style="font-size: 1.2em; margin-bottom: 10px;">Aper√ßu 3D</h2>
            <div class="view-switcher" id="shape-switcher">
                <button id="viewCubeBtn" class="active">Cube</button>
                <button id="viewSphereBtn">Sph√®re</button>
            </div>
            <canvas id="threeCanvas"></canvas>
            <div style="margin-top: 10px; width: 100%;">
                <label for="roughnessSlider">Rugosit√© <span id="roughnessValue" class="value-display">0.6</span></label>
                <input type="range" id="roughnessSlider" min="0" max="1" value="0.6" step="0.01">
            </div>
        </div>
    </div>
</div>

<!-- Chargement des modules JS s√©par√©s.
       IMPORTANT : ordre de chargement -> heightmap, normalmap, roughness, main -->
<script src="./3d-normal-map-generator/3D-normal-map-generator.heightmap.js"></script>
<script src="./3d-normal-map-generator/3D-normal-map-generator.normalmap.js"></script>
<script src="./3d-normal-map-generator/3D-normal-map-generator.roughness.js"></script>
<script src="./3d-normal-map-generator/3D-normal-map-generator.main.js"></script>

<script>
document.querySelectorAll('input[type="range"]').forEach(slider => {
  const valueDisplay = document.getElementById(slider.id + "Value");
  if (valueDisplay) {
    // Met √† jour imm√©diatement √† l'ouverture
    valueDisplay.textContent = parseFloat(slider.value).toFixed(2);

    // Met √† jour √† chaque changement de curseur
    slider.addEventListener("input", () => {
      let value = parseFloat(slider.value);
      // Si max > 10 (comme les niveaux), on affiche sans d√©cimales
      valueDisplay.textContent = value > 10 ? Math.round(value) : value.toFixed(2);
    });
  }
});
</script>
<script>
document.querySelectorAll('input[type="range"]').forEach(slider => {
  const valueDisplay = document.getElementById(slider.id + "Value");
  if (valueDisplay) {
    // Cr√©e le bouton reset
    const resetBtn = document.createElement("button");
    resetBtn.textContent = "‚Ü∫";
    resetBtn.className = "reset-btn";
    valueDisplay.parentElement.appendChild(resetBtn);

    // Valeur initiale
    const defaultValue = slider.getAttribute("value");

    // Met √† jour l'affichage initial
    const updateDisplay = () => {
      let value = parseFloat(slider.value);
      valueDisplay.textContent = value > 10 ? Math.round(value) : value.toFixed(2);
    };
    updateDisplay();

    // Quand on bouge le curseur
    slider.addEventListener("input", updateDisplay);

    // Quand on clique sur reset
    resetBtn.addEventListener("click", () => {
      slider.value = defaultValue;
      updateDisplay();
      slider.dispatchEvent(new Event("input")); // pour d√©clencher d'autres √©ventuelles mises √† jour
    });
  }
});
</script>
<script>
const fileInput = document.getElementById("imageLoader");
const fileNameDisplay = document.getElementById("fileName");

fileInput.addEventListener("change", () => {
  if (fileInput.files.length > 0) {
    fileNameDisplay.textContent = "üìÑ " + fileInput.files[0].name;
  } else {
    fileNameDisplay.textContent = "Aucun fichier s√©lectionn√©";
  }
});
</script>

<script>
document.querySelectorAll(".accordion-header").forEach(header => {
  header.addEventListener("click", () => {
    const section = header.parentElement;
    section.classList.toggle("closed");
  });
});
</script>

</body>
</html>