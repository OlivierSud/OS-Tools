<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cr√©ateur de vid√©o : images ‚Üí MP4 (H.265 si disponible)</title>
  <style>
    :root{ --bg:#061c30; --panel:#082137; --panel-2:#051727; --border:#051727; --text:#d7dde7; --muted:#9aa5b1; --accent1:#4f8cff; --accent2:#7a5cff; --accent3:#4fff95; --accent4:#5cff85; --good:#20c997; --warn:#ffcc66; --bad:#ff6b6b; }
    body{margin:0;background:linear-gradient(180deg,#051727,#0c1c30);color:var(--text);font:15px/1.4 system-ui}
    .wrap{max-width:1000px;margin:32px auto;padding:0 16px}
    .card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    header{display:flex;gap:14px;align-items:center;justify-content:space-between;margin-bottom:16px}
    header h1{font-size:20px;margin:0;font-weight:700}
    header .hint{color:var(--muted);font-size:13px}
    .controls{display:grid;gap:12px;padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    label{font-weight:600}
    input[type="file"],input[type="number"],input[type="text"]{padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.2);background:#0f162b;color:var(--text)}
    input[type="range"]{width:260px}
    button{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;border:0;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    button:hover{background:linear-gradient(135deg,var(--accent3),var(--accent4));color:#011b0a}
    button:disabled{opacity:0.5;cursor:not-allowed}
    button.secondary{background:#1a233d}
    .preview{display:grid;gap:10px;padding:16px}
    canvas{width:100%;background:#000;border-radius:12px;border:1px solid rgba(255,255,255,.1)}
    .playerbar{display:flex;align-items:center;gap:10px}
    .pill{font-size:12px;color:var(--muted)}
    .timeline{flex:1}
    .log{white-space:pre-wrap;font-family:monospace;background:#0e1426;border-top:1px solid rgba(255,255,255,.08);border-radius:0 0 16px 16px;padding:12px;color:#cfe0ff;max-height:140px;overflow:auto}
    .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .footer{color:var(--muted);font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Cr√©ateur de vid√©o (images ‚Üí MP4 H.265 si pris en charge)</h1>
      <div class="hint">S√©lectionnez un dossier d'images, ajustez la vitesse et la taille, pr√©visualisez puis exportez.</div>
    </header>

    <section class="card">
      <div class="controls">
        <div class="row">
          <label>Source d'images :</label>
          <input id="picker" type="file" webkitdirectory multiple accept="image/*" />
          <span class="pill" id="count">0 image</span>
        </div>
        <div class="row">
          <label for="fps">Vitesse (images/seconde) :</label>
          <input id="fps" type="range" min="1" max="60" value="24">
          <input id="fpsText" type="number" min="1" max="60" value="24">
          <span class="pill">Dur√©e estim√©e : <span id="est"></span></span>
        </div>
        <div class="row">
          <label>Largeur :</label>
          <input id="widthInput" type="number" min="16" max="3840">
          <label>Hauteur :</label>
          <input id="heightInput" type="number" min="16" max="2160">
        </div>
        <div class="row">
          <label>Nom du fichier export√© :</label>
          <input id="filename" type="text" value="export_video">
        </div>
      </div>
      <div class="preview">
        <canvas id="canvas"></canvas>
        <div class="playerbar">
          <button id="play">‚ñ∂Ô∏è Lire</button>
          <button id="stop">‚èπÔ∏è Stop</button>
          <button id="restart">‚èÆÔ∏è Recommencer</button>
          <input id="timeline" class="timeline" type="range" min="0" max="100" value="0">
          <div class="pill" id="codecInfo">Codec demand√© : H.265 / MP4</div>
          <span class="pill" id="status"></span>
          <button id="export">üíæ Exporter</button>
        </div>
      </div>
      <div class="log" id="log"></div>
    </section>

    <div class="footer">‚ö†Ô∏è Remarque : l'encodage H.265/MP4 dans le navigateur n'est <b>pas</b> disponible partout. Si non pris en charge, fallback en H.264/VP9/VP8.</div>
  </div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const picker = $('picker'), fpsRange=$('fps'), fpsText=$('fpsText'),
        est=$('est'), count=$('count'), canvas=$('canvas'),
        playBtn=$('play'), stopBtn=$('stop'), restartBtn=$('restart'),
        exportBtn=$('export'), timeline=$('timeline'),
        logEl=$('log'), statusEl=$('status'), codecInfo=$('codecInfo'),
        widthInput=$('widthInput'), heightInput=$('heightInput'),
        filenameInput=$('filename');
  const ctx = canvas.getContext('2d');

  let frames=[], playing=false, previewTimer=null, frameIndex=0;

  function log(msg, cls=''){ let d=document.createElement('div'); if(cls) d.className=cls; d.textContent=msg; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }
  function fmtDur(t){ return `${Math.floor(t/60)}:${String(Math.round(t%60)).padStart(2,'0')}`; }

  async function loadImages(fileList){
    frames=[]; frameIndex=0;
    const files=Array.from(fileList).filter(f=>f.type.startsWith('image/'))
      .sort((a,b)=>a.webkitRelativePath.localeCompare(b.webkitRelativePath)||a.name.localeCompare(b.name));
    count.textContent=`${files.length} image${files.length>1?'s':''}`;
    if(!files.length){ log('Aucune image d√©tect√©e.','warn'); return; }
    log(`Chargement de ${files.length} image(s)...`);
    for(const f of files){ try{ let bmp=await createImageBitmap(f); frames.push({bmp,w:bmp.width,h:bmp.height,name:f.name}); }catch(e){ log(`√âchec ${f.name}`,'bad'); } }
    if(frames.length){
      const {w,h,name}=frames[0];
      widthInput.value=w; heightInput.value=h;
      canvas.width=w; canvas.height=h;
      filenameInput.value=name.replace(/\.[^.]+$/,''); // nom par d√©faut
      drawFrame(0); updateEst();
      timeline.max=frames.length-1; timeline.value=0;
      log('Images pr√™tes ‚úî','ok');
    }
  }

  function drawFrame(i){ if(!frames.length) return;
    frameIndex=i%frames.length; const {bmp}=frames[frameIndex];
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(bmp,0,0,canvas.width,canvas.height);
    timeline.value=frameIndex;
  }

  function updateCanvasSize(){ canvas.width=parseInt(widthInput.value)||canvas.width; canvas.height=parseInt(heightInput.value)||canvas.height; drawFrame(frameIndex); }
  function updateEst(){ let fps=+fpsRange.value,total=frames.length/(fps||1); est.textContent=frames.length?`${fmtDur(total)} pour ${frames.length} img`:'‚Äî'; }
  function syncFpsInputs(v){ fpsRange.value=v; fpsText.value=v; updateEst(); }

  async function exportVideo(){
    if(!frames.length) return log('Aucune image √† exporter.','warn');
    stopPreview();
    exportBtn.disabled=true; // d√©sactiver bouton
    const fps=+fpsRange.value, stream=canvas.captureStream(fps), mime=pickBestMime();
    if(!mime){ log('Export vid√©o non support√©','bad'); exportBtn.disabled=false; return; }
    codecInfo.textContent=`Codec choisi : ${mime}`;
    const rec=new MediaRecorder(stream,{mimeType:mime,videoBitsPerSecond:6000000});
    const chunks=[]; rec.ondataavailable=e=>e.data.size&&chunks.push(e.data);
    let i=0, drawInterval=setInterval(()=>{ drawFrame(i++); if(i>=frames.length){ clearInterval(drawInterval); rec.stop(); } },1000/fps);
    rec.onstop=()=>{
      let blob=new Blob(chunks,{type:mime}), url=URL.createObjectURL(blob),
          ext=mime.includes('mp4')?'mp4':'webm', a=document.createElement('a');
      a.href=url; a.download=(filenameInput.value||'export')+'.'+ext; a.click();
      URL.revokeObjectURL(url); log('Export termin√© ‚úî','ok'); statusEl.textContent=''; exportBtn.disabled=false;
    };
    rec.start(); statusEl.textContent='Export en cours...';
  }

  function pickBestMime(){ return ['video/mp4;codecs=hvc1','video/mp4;codecs=hev1','video/mp4;codecs=avc1.42E01E','video/webm;codecs=vp9','video/webm;codecs=vp8'].find(m=>MediaRecorder.isTypeSupported(m))||''; }
  function startPreview(){ if(!frames.length||playing) return; playing=true; statusEl.textContent='Pr√©visualisation...'; previewTimer=setInterval(()=>drawFrame(frameIndex+1),1000/(+fpsRange.value||24)); playBtn.textContent='‚è∏Ô∏è Pause'; }
  function stopPreview(){ playing=false; clearInterval(previewTimer); previewTimer=null; playBtn.textContent='‚ñ∂Ô∏è Lire'; statusEl.textContent=''; }
  function togglePreview(){ playing?stopPreview():startPreview(); }
  function restartPreview(){ frameIndex=0; drawFrame(0); if(!playing) statusEl.textContent=''; }

  picker.addEventListener('change',e=>loadImages(e.target.files));
  fpsRange.addEventListener('input',e=>syncFpsInputs(e.target.value));
  fpsText.addEventListener('input',e=>syncFpsInputs(Math.min(60,Math.max(1,+e.target.value||24))));
  widthInput.addEventListener('input',updateCanvasSize); heightInput.addEventListener('input',updateCanvasSize);
  playBtn.addEventListener('click',togglePreview); stopBtn.addEventListener('click',stopPreview); restartBtn.addEventListener('click',restartPreview);
  exportBtn.addEventListener('click',exportVideo); timeline.addEventListener('input',e=>drawFrame(+e.target.value));
})();
</script>
</body>
</html>
